import Head from 'next/head'
import Image from 'next/image'
import { Container } from './styles'
import Logo from '../../public/LOREMIPSUM.svg'
import Mark from '../../public/mark.svg'
import React, { useState, useContext } from 'react'
import { GetServerSideProps, NextPage } from 'next'
import Modal from '../components/Modal'

import GoogleMapReact from 'google-map-react';
import { ListaDenunciaUseCase } from '../@core/application/denuncia/listar-denuncia.use-case'
import { DenunciaHttpGateway } from '../@core/infra/gateways/denuncia-http.gateway'
import { http } from '../@core/infra/gateways/http'
import { container, Registry } from '../@core/infra/container-registry'
import { Denuncia } from '../@core/domain/entities/denuncia'
import { PosicaoContext } from '../context/posicao.provider'
import { BuscarDenunciaPorIdUseCase } from '../@core/application/denuncia/buscar-denuncia-por-id.use-case'

type DenunciasProps = {
    denuncias: Denuncia[]
}

const Denuncias: NextPage<DenunciasProps> = ({
    denuncias
}) => {

    const [isOpen, setIsOpen] = useState(false);
    const [denunciaModal, setDenunciaModal] = useState<Denuncia>();

    const posicaoContext = useContext(PosicaoContext);
    
    const defaultProps = {
        center: {
            lat: posicaoContext.lat,
            lng: posicaoContext.lng
        },
        zoom: posicaoContext.zoom
    };

     const  abrirDenuncia = async (id: number) => {

        setIsOpen(true);

        const useCase = container.get<BuscarDenunciaPorIdUseCase>(Registry.BuscarDenunciaPorId);
        const denuncia = await useCase.execute(id);
        setDenunciaModal(denuncia);
    }

    return (
        <Container>
            <Head>
                <title>Create Next App</title>
                <meta name="description" content="Generated by create next app" />
                <link rel="icon" href="/favicon.ico" />
            </Head>
            {isOpen && <Modal denuncia={denunciaModal} setIsOpen={setIsOpen} />}

            <div className='header'>
                <div className="header__logo">
                    <Image alt='EuFiscal logo' src={Logo} />
                </div>
                <div className="header__menu-mobile">
                    <button>a</button>
                    <button>b</button>
                    <button>c</button>
                </div>
                <div className="header__menu">
                    <input type="text" placeholder='Pesquise uma cidade' className='header__pesquisar' />
                    <div className='header__container-select'>
                        <select className='header__select' name="" id="">
                            <option value="lorem">lorem</option>
                            <option value="ipsum">ipsum</option>
                            <option value="dolor">dolor</option>
                        </select>
                        <select className='header__select' name="" id="">
                            <option value="lorem">lorem</option>
                            <option value="ipsum">ipsum</option>
                            <option value="dolor">dolor</option>
                        </select>
                        <select className='header__select' name="" id="">
                            <option value="lorem">lorem</option>
                            <option value="ipsum">ipsum</option>
                            <option value="dolor">dolor</option>
                        </select>
                    </div>
                </div>
            </div>

            <div className='container-main'>
                <div className='mapa'>
                    <GoogleMapReact
                        bootstrapURLKeys={{ key: "CHAVE_AQUI" }}
                        defaultCenter={defaultProps.center}
                        defaultZoom={defaultProps.zoom}
                    >
                        {
                            denuncias.map((denuncia: Denuncia) => (
                                <div
                                    className='mark'
                                    key={denuncia.id}
                                    lat={denuncia.lat}
                                    lng={denuncia.lng}
                                    onClick={() => {abrirDenuncia(denuncia.id)}}
                                >
                                    <Image alt="" src={Mark} />    
                                </div>
                            ))
                        }
                    </GoogleMapReact>
                </div>
                <div className='section'>
                    {
                        denuncias.map((denuncia: Denuncia) => (
                            <div onClick={() => {abrirDenuncia(denuncia.id)}} key={denuncia.id} className='card'>
                                <div className="card__imagem"></div>
                                <div className="card__meta">
                                    <div className="card__subtitulo">{denuncia.status.abertura.data}</div>
                                    <div className="card__titulo">{denuncia.titulo}</div>
                                    <div className="card__categoria">{denuncia.nomeCategoria}</div>
                                </div>
                            </div>
                        ))
                    }
                </div>
            </div>
        </Container>
    )
}

export default Denuncias;

export const getServerSideProps: GetServerSideProps = async (context) => {

    const useCase = container.get<ListaDenunciaUseCase>(Registry.ListaDenunciaUseCase);
    const denuncias = await useCase.execute();
    
    return ({
        props: {
            denuncias: denuncias.map(denuncia => denuncia.toJSON())
        },
    })
}
